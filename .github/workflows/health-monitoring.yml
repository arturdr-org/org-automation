name: ğŸ¥ Health Monitoring & Alerting

on:
  workflow_dispatch: {}
  schedule:
    # Executa health check duas vezes por dia
    - cron: '0 6,18 * * *'  # 6:00 e 18:00 UTC
  workflow_run:
    workflows: ["ğŸš€ Enhanced Organization Automation"]
    types: [completed]

env:
  ORG_NAME: arturdr-org

jobs:
  health-check:
    name: ğŸ” VerificaÃ§Ã£o de SaÃºde
    runs-on: ubuntu-latest
    
    outputs:
      health-status: ${{ steps.health-check.outputs.status }}
      compliance-rate: ${{ steps.health-check.outputs.compliance }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”‘ AutenticaÃ§Ã£o
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.ORG_APP_ID }}
          private-key: ${{ secrets.ORG_APP_PRIVATE_KEY }}
          owner: arturdr-org

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install -r requirements.txt

      - name: ğŸ¥ Executar Health Check
        id: health-check
        env:
          ORG_AUTOMATION_PAT: ${{ steps.app-token.outputs.token || secrets.ORG_AUTOMATION_PAT }}
        run: |
          echo "ğŸ¥ Executando verificaÃ§Ã£o de saÃºde..."
          python monitoring.py
          
          # Capturar dados para outputs
          if [ -f health_report_*.json ]; then
            latest_report=$(ls -t health_report_*.json | head -1)
            health_status=$(jq -r '.overall_health' "$latest_report")
            compliance_rate=$(jq -r '.automation_stats.compliance_percentage' "$latest_report")
            
            echo "status=$health_status" >> $GITHUB_OUTPUT
            echo "compliance=$compliance_rate" >> $GITHUB_OUTPUT
            
            echo "âœ… Health status: $health_status"
            echo "ğŸ“Š Compliance rate: $compliance_rate%"
          fi

      - name: ğŸ“Š Gerar Dashboard Organizacional
        env:
          ORG_AUTOMATION_PAT: ${{ steps.app-token.outputs.token || secrets.ORG_AUTOMATION_PAT }}
        run: |
          echo "ğŸ“Š Gerando dashboard organizacional..."
          python dashboard.py

      - name: ğŸ“Š Upload relatÃ³rios e dashboard
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: health-reports-${{ github.run_number }}
          path: |
            health_report_*.txt
            health_report_*.json
            dashboard_*.html
            dashboard_metrics_*.json
          retention-days: 90

      - name: ğŸ“ˆ Resumo no GitHub
        if: always()
        run: |
          echo "## ğŸ¥ Health Check da OrganizaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f health_report_*.txt ]; then
            latest_txt=$(ls -t health_report_*.txt | head -1)
            echo "### ğŸ“‹ Resumo do RelatÃ³rio:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 30 "$latest_txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  alert-on-issues:
    name: ğŸš¨ Alertas e NotificaÃ§Ãµes
    needs: health-check
    runs-on: ubuntu-latest
    if: needs.health-check.outputs.health-status == 'critical'
    
    steps:
      - name: ğŸ”” Criar Issue CrÃ­tico
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const compliance = '${{ needs.health-check.outputs.compliance-rate }}';
            const status = '${{ needs.health-check.outputs.health-status }}';
            
            const title = `ğŸš¨ ALERTA: SaÃºde da AutomaÃ§Ã£o em Estado CrÃ­tico`;
            const body = `
            ## ğŸš¨ Alerta de SaÃºde da AutomaÃ§Ã£o
            
            A verificaÃ§Ã£o de saÃºde da organizaÃ§Ã£o detectou problemas crÃ­ticos que requerem atenÃ§Ã£o imediata.
            
            ### ğŸ“Š MÃ©tricas Atuais:
            - **Status Geral**: ${status.toUpperCase()}
            - **Taxa de Conformidade**: ${compliance}%
            - **Data da VerificaÃ§Ã£o**: ${new Date().toISOString()}
            
            ### ğŸ”— Links Ãšteis:
            - [ExecuÃ§Ã£o do Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Painel de Actions](${{ github.server_url }}/${{ github.repository }}/actions)
            
            ### ğŸ› ï¸ PrÃ³ximos Passos:
            1. Baixar e analisar os relatÃ³rios detalhados
            2. Identificar repositÃ³rios com baixa conformidade
            3. Executar automaÃ§Ã£o manual se necessÃ¡rio
            4. Verificar logs de workflows anteriores
            
            ### âš¡ AÃ§Ã£o Recomendada:
            Execute o workflow de automaÃ§Ã£o manualmente com modo DRY-RUN primeiro para identificar problemas especÃ­ficos.
            
            ---
            *Este alerta foi gerado automaticamente pelo sistema de monitoramento.*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automation', 'priority:critical', 'type:security', 'status:blocked']
            });

  weekly-report:
    name: ğŸ“Š RelatÃ³rio Semanal
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 6 * * 1'  # Segunda-feira 6:00 UTC
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”‘ AutenticaÃ§Ã£o
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.ORG_APP_ID }}
          private-key: ${{ secrets.ORG_APP_PRIVATE_KEY }}
          owner: arturdr-org

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install -r requirements.txt

      - name: ğŸ“Š Gerar RelatÃ³rio Semanal
        env:
          ORG_AUTOMATION_PAT: ${{ steps.app-token.outputs.token || secrets.ORG_AUTOMATION_PAT }}
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio semanal..."
          python monitoring.py
          
          # Criar issue com relatÃ³rio semanal
          if [ -f health_report_*.json ]; then
            echo "WEEKLY_REPORT_GENERATED=true" >> $GITHUB_ENV
          fi

      - name: ğŸ“¬ Criar Issue com RelatÃ³rio Semanal
        if: env.WEEKLY_REPORT_GENERATED == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_AUTOMATION_PAT }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Encontrar o relatÃ³rio mais recente
            const files = fs.readdirSync('.')
              .filter(f => f.startsWith('health_report_') && f.endsWith('.txt'))
              .sort()
              .reverse();
            
            if (files.length > 0) {
              const reportContent = fs.readFileSync(files[0], 'utf8');
              const weekNumber = Math.ceil(((new Date() - new Date(new Date().getFullYear(), 0, 1)) / 86400000 + 1) / 7);
              
              const title = `ğŸ“Š RelatÃ³rio Semanal de AutomaÃ§Ã£o - Semana ${weekNumber}/${new Date().getFullYear()}`;
              const body = `
              ## ğŸ“Š RelatÃ³rio Semanal da AutomaÃ§Ã£o da OrganizaÃ§Ã£o
              
              ### ğŸ“… PerÃ­odo: Semana ${weekNumber} de ${new Date().getFullYear()}
              
              \`\`\`
              ${reportContent}
              \`\`\`
              
              ---
              *RelatÃ³rio gerado automaticamente todas as segundas-feiras.*
              `;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automation', 'type:maintenance', 'weekly-report']
              });
            }

      - name: ğŸ“Š Upload RelatÃ³rio Semanal
        uses: actions/upload-artifact@v4
        with:
          name: weekly-report-${{ github.run_number }}
          path: |
            health_report_*.txt
            health_report_*.json
          retention-days: 365  # Manter relatÃ³rios semanais por 1 ano