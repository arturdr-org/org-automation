# ğŸ›¡ï¸ Security Audit Pipeline - Continuous Security Monitoring
# Workflow especializado em seguranÃ§a com mÃºltiplos scanners

name: "ğŸ›¡ï¸ Security Audit"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ExecuÃ§Ã£o diÃ¡ria Ã s 02:00 UTC (seguranÃ§a contÃ­nua)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - dependencies
          - code
          - secrets

env:
  PYTHON_VERSION: '3.9'

jobs:
  # ============================================
  # ğŸ” Secret Scanning
  # ============================================
  secret-scan:
    name: "ğŸ” Secret Detection"
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'full' || inputs.scan_type == 'secrets' || inputs.scan_type == '' }}
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Full history for secret scanning
    
    - name: "ğŸ•µï¸ GitLeaks Secret Scan"
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        
    - name: "ğŸ”’ TruffleHog Secret Scan"
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
    
    - name: "ğŸ“Š Upload Secret Scan Results"
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: secret-scan-results
        path: |
          gitleaks-report.json
          trufflehog-results.json

  # ============================================
  # ğŸ”¬ Dependency Security Analysis
  # ============================================
  dependency-audit:
    name: "ğŸ”¬ Dependency Security"
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'full' || inputs.scan_type == 'dependencies' || inputs.scan_type == '' }}
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v5
    
    - name: "ğŸ Setup Python"
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: "ğŸ“¦ Install Dependencies"
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety pip-audit
        
    - name: "ğŸ”’ Snyk Dependency Scan"
      uses: snyk/actions/python@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium --file=requirements.txt --json-file-output=snyk-dependencies.json
        command: test
      continue-on-error: true
        
    - name: "ğŸ›¡ï¸ Safety Dependency Check"
      run: |
        echo "ğŸ›¡ï¸ Executando Safety check..."
        safety check --json --output safety-report.json || true
        safety check --short-report
      continue-on-error: true
        
    - name: "ğŸ” Pip-Audit Scan"
      run: |
        echo "ğŸ” Executando Pip-Audit..."
        pip-audit --output=json --output-file=pip-audit-report.json || true
        pip-audit --desc
      continue-on-error: true
        
    - name: "ğŸ“Š Upload Dependency Scan Results"
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-scan-results
        path: |
          snyk-dependencies.json
          safety-report.json
          pip-audit-report.json

  # ============================================
  # ğŸ§¬ Code Security Analysis
  # ============================================
  code-security:
    name: "ğŸ§¬ Code Security Analysis"
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'full' || inputs.scan_type == 'code' || inputs.scan_type == '' }}
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v5
    
    - name: "ğŸ Setup Python"
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: "ğŸ“¦ Install Security Tools"
      run: |
        python -m pip install --upgrade pip
        pip install bandit semgrep
        
    - name: "ğŸ” CodeQL Security Analysis"
      uses: github/codeql-action/init@v2
      with:
        languages: python
        queries: security-extended,security-and-quality
        
    - name: "ğŸ”¬ Run CodeQL Analysis"
      uses: github/codeql-action/analyze@v2
      
    - name: "ğŸ”’ Bandit Security Scan"
      run: |
        echo "ğŸ”’ Executando Bandit security scan..."
        bandit -r . -f json -o bandit-security-report.json || true
        bandit -r . --severity-level medium --confidence-level medium
      continue-on-error: true
        
    - name: "âš¡ Semgrep Security Scan"
      run: |
        echo "âš¡ Executando Semgrep security scan..."
        semgrep --config=auto --json --output=semgrep-report.json . || true
        semgrep --config=p/security-audit --config=p/python .
      continue-on-error: true
        
    - name: "ğŸ“Š Upload Code Security Results"
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-security-results
        path: |
          bandit-security-report.json
          semgrep-report.json

  # ============================================
  # ğŸŒ Infrastructure Security
  # ============================================
  infrastructure-audit:
    name: "ğŸŒ Infrastructure Security"
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'full' || inputs.scan_type == '' }}
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v5
      
    - name: "ğŸ—ï¸ Docker Security Scan"
      if: hashFiles('**/Dockerfile') != ''
      run: |
        echo "ğŸ—ï¸ Verificando Dockerfiles..."
        find . -name "Dockerfile*" -type f | head -5
        # Adicionar hadolint ou docker scout se houver Dockerfiles
        
    - name: "âš™ï¸ GitHub Actions Security"
      run: |
        echo "âš™ï¸ Verificando workflows do GitHub Actions..."
        find .github/workflows -name "*.yml" -exec echo "Checking {}" \;
        # Adicionar actionlint se necessÃ¡rio
        
    - name: "ğŸ”§ Configuration Security Check"
      run: |
        echo "ğŸ”§ Verificando arquivos de configuraÃ§Ã£o..."
        # Verificar arquivos sensÃ­veis
        find . -name "*.env*" -o -name "*.config" -o -name "*.ini" | grep -v node_modules || echo "Nenhum arquivo sensÃ­vel encontrado"
        
    - name: "ğŸ“‹ Security Policy Check"
      run: |
        echo "ğŸ“‹ Verificando polÃ­ticas de seguranÃ§a..."
        if [ -f "SECURITY.md" ]; then
          echo "âœ… SECURITY.md encontrado"
        else
          echo "âš ï¸ SECURITY.md nÃ£o encontrado - considere criar um"
        fi

  # ============================================
  # ğŸ“Š Security Report Generation
  # ============================================
  security-report:
    name: "ğŸ“Š Security Report"
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-audit, code-security, infrastructure-audit]
    if: always()
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v5
    
    - name: "ğŸ“¤ Download All Scan Results"
      uses: actions/download-artifact@v3
      with:
        path: security-reports/
        
    - name: "ğŸ Setup Python for Report Generation"
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: "ğŸ“Š Generate Consolidated Security Report"
      run: |
        python -c "
        import json
        import os
        from datetime import datetime
        
        print('ğŸ“Š Generating consolidated security report...')
        
        report = {
            'scan_date': datetime.now().isoformat(),
            'repository': '${{ github.repository }}',
            'commit': '${{ github.sha }}',
            'scan_type': '${{ inputs.scan_type || 'full' }}',
            'results': {}
        }
        
        # Verificar resultados dos scans
        for root, dirs, files in os.walk('security-reports'):
            for file in files:
                if file.endswith('.json'):
                    try:
                        with open(os.path.join(root, file)) as f:
                            data = json.load(f)
                            report['results'][file] = {
                                'found': len(data) if isinstance(data, list) else 1,
                                'summary': f'Found issues in {file}'
                            }
                    except:
                        report['results'][file] = {'error': 'Could not parse results'}
        
        with open('consolidated-security-report.json', 'w') as f:
            json.dump(report, f, indent=2)
            
        print('âœ… Security report generated successfully')
        "
        
    - name: "ğŸ“‹ Security Summary"
      run: |
        echo "## ğŸ›¡ï¸ Security Audit Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Secret Scan | ${{ needs.secret-scan.result == 'success' && 'âœ… Clean' || needs.secret-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependencies | ${{ needs.dependency-audit.result == 'success' && 'âœ… Secure' || needs.dependency-audit.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Vulnerabilities Found' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Security | ${{ needs.code-security.result == 'success' && 'âœ… Secure' || needs.code-security.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Infrastructure | ${{ needs.infrastructure-audit.result == 'success' && 'âœ… Secure' || needs.infrastructure-audit.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Security Resources" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub Security Tab**: [View Alerts](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
        echo "- **Snyk Dashboard**: [View Vulnerabilities](https://snyk.io/org/arturdr-org)" >> $GITHUB_STEP_SUMMARY
        echo "- **Scan Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        
    - name: "ğŸ’¾ Upload Consolidated Report"
      uses: actions/upload-artifact@v3
      with:
        name: consolidated-security-report
        path: consolidated-security-report.json
        
    - name: "ğŸš¨ Security Alert (if issues found)"
      if: |
        needs.secret-scan.result == 'failure' || 
        needs.dependency-audit.result == 'failure' || 
        needs.code-security.result == 'failure'
      run: |
        echo "ğŸš¨ ATENÃ‡ÃƒO: Problemas de seguranÃ§a encontrados!"
        echo "Verifique os artefatos e relatÃ³rios para mais detalhes."
        exit 1